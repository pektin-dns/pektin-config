$schema: http://json-schema.org/draft-07/schema#
title: Pektin Config
description: The configuration for the Pektin DNS server
type: object
additionalProperties: false
properties:
    services:
        type: object
        additionalProperties: false
        required:
            - ui
            - api
            - vault
            - recursor
            - ribston
            - opa
        properties:
            ui:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - subDomain
                    - domain
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: add/remove in routing settings
                                      - place: [compose, compose-scripts]
                                        comments: add/remove file in compose command
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: add/remove AAAA and A records for this service
                    domain:
                        $ref: "#/$defs/DomainName"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update name in routing config
                                      - place: [api, dns, services, SOA-records NS-records]
                                        comments: update name in SOA and NS records
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: update name in AAAA and A records

                    subDomain:
                        $ref: "#/$defs/SubDomain"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update name in routing config
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: update name in AAAA and A records

            api:
                type: object
                additionalProperties: false
                required:
                    - subDomain
                    - domain
                properties:
                    domain:
                        $ref: "#/$defs/DomainName"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update name in routing config
                                      - place: [api, dns, services, SOA-records NS-records]
                                        comments: update name in SOA and NS records
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: update name in AAAA and A records

                    subDomain:
                        $ref: "#/$defs/SubDomain"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update name in routing config
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: update name in AAAA and A records

            vault:
                type: object
                additionalProperties: false
                required:
                    - subDomain
                    - domain
                properties:
                    domain:
                        $ref: "#/$defs/DomainName"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update name in routing config
                                      - place: [api, dns, services, SOA-records NS-records]
                                        comments: update name in SOA and NS records
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: update name in AAAA and A records
                    subDomain:
                        $ref: "#/$defs/SubDomain"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update name in routing config
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: update name in AAAA and A records

            recursor:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - subDomain
                    - domain
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: add/remove in routing settings
                                      - place: [compose, compose-scripts]
                                        comments: add/remove file in compose command
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: add/remove AAAA and A records for this service
                    domain:
                        $ref: "#/$defs/DomainName"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update name in routing config
                                      - place: [api, dns, services, SOA-records NS-records]
                                        comments: update name in SOA and NS records
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: update name in AAAA and A records
                    subDomain:
                        $ref: "#/$defs/SubDomain"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update name in routing config
                                      - place: [api, dns, services, AAAA-records-A-records]
                                        comments: update name in AAAA and A records

            ribston:
                type: object
                additionalProperties: false
                required:
                    - enabled
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, compose-scripts]
                                        comments: include file in compose command

            opa:
                type: object
                additionalProperties: false
                required:
                    - enabled
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, compose-scripts]
                                        comments: include file in compose command

    usePolicies:
        type: string
        enum: [ribston, opa, both, false]
        examples:
            - meta:
                  updatable: true
                  use:
                      - place: [compose, secrets, .env, USE_POLICIES]
                        comments: update variable in .env file
    nodes:
        type: array
        minItems: 1
        items:
            type: object
            additionalProperties: false
            required:
                - name
            properties:
                main:
                    type: boolean
                    examples:
                        - meta:
                              updatable: false
                ips:
                    type: array
                    minItems: 1
                    items:
                        $ref: "#/$defs/Ip"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [api, dns, nameservers, AAAA-records]
                                        comments: update address in AAAA records for related nameservers
                                      - place: [api, dns, services, AAAA-records]
                                        comments: update address in AAAA records for services if main node
                legacyIps:
                    type: array
                    minItems: 1
                    items:
                        $ref: "#/$defs/LegacyIp"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [api, dns, nameservers, A-records]
                                        comments: update address in A records for related nameservers
                                      - place: [api, dns, services, A-records]
                                        comments: update address in A records for services if main node

                name:
                    type: string
                    examples:
                        - meta:
                              updatable: false

                ansible:
                    $ref: "#/$defs/AnsibleConfig"
                    examples:
                        - meta:
                              updatable: false

                setup:
                    type: object
                    additionalProperties: false
                    required:
                        - system
                        - root
                        - cloneRepo
                        - setup
                        - start
                    properties:
                        system:
                            type: string
                            examples:
                                - meta:
                                      updatable: false
                        root:
                            type: object
                            additionalProperties: false
                            properties:
                                disableSystemdResolved:
                                    type: boolean
                                    examples:
                                        - meta:
                                              updatable: false
                                installDocker:
                                    type: boolean
                                    examples:
                                        - meta:
                                              updatable: false
                            required:
                                - disableSystemdResolved
                                - installDocker
                        cloneRepo:
                            type: boolean
                            examples:
                                - meta:
                                      updatable: false
                        setup:
                            type: boolean
                            examples:
                                - meta:
                                      updatable: false
                        start:
                            type: boolean
                            examples:
                                - meta:
                                      updatable: false

    nameservers:
        type: array
        minItems: 1
        # one nameserver (for each domain) must have the main attribute set to true
        items:
            type: object
            additionalProperties: false
            required:
                - domain
                - node
            properties:
                subDomain:
                    $ref: "#/$defs/SubDomain"
                    examples:
                        - meta:
                              updatable: true
                              use:
                                  - place: [api, dns, nameservers, name]
                                    comments: update value in NS record
                                  - place: [api, dns, soa, mname]
                                    comments: update mname in SOA record if main NS
                                  - place: [compose, secrets, traefik, dynamic-config]
                                    comments: update name in routing config tls sni and http router
                domain:
                    $ref: "#/$defs/DomainName"
                    examples:
                        - meta:
                              updatable: true
                              use:
                                  - place: [api, dns, nameservers, name]
                                    comments: update value in NS record
                                  - place: [api, dns, soa, mname]
                                    comments: update mname in SOA record if main NS
                                  - place: [compose, secrets, traefik, dynamic-config]
                                    comments: update name in routing config tls sni and http router
                                  - place: [vault, signer]
                                    comments: update signer for new domain
                node:
                    type: string
                    examples:
                        - meta:
                              updatable: false

                main:
                    type: boolean
                    examples:
                        - meta:
                              updatable: true
                              use:
                                  - place: [api, dns, soa, mname]
                                    comments: update mname in SOA record
    letsencrypt:
        type: object
        additionalProperties: false
        required:
            - enabled
            - letsencryptEmail
        properties:
            enabled:
                type: boolean
                examples:
                    - meta:
                          updatable: true
                          use:
                              - place: [compose, secrets, traefik, static-config, certificate-resolvers]
                                comments: create cert resolvers in routing config
            letsencryptEmail:
                $ref: "#/$defs/Email"
                examples:
                    - meta:
                          updatable: true
                          use:
                              - place: [compose, secrets, traefik, static-config, certificate-resolvers]
                                comments: update email in the routing config if enabled

    build:
        type: object
        additionalProperties: false
        required:
            - server
            - api
            - ui
            - ribston
            - recursor
            - vault
        properties:
            server:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - path
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, compose-scripts]
                                        comments: add/remove build file with -f
                    path:
                        type: string
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, env]
                                        comments: update build path in .env file
            api:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - path
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, compose-scripts]
                                        comments: add/remove build file with -f
                    path:
                        type: string
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, env]
                                        comments: update build path in .env file

            ui:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - path
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, compose-scripts]
                                        comments: add/remove build file with -f
                    path:
                        type: string
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, env]
                                        comments: update build path in .env file

            ribston:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - path
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, compose-scripts]
                                        comments: add/remove build file with -f
                    path:
                        type: string
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, env]
                                        comments: update build path in .env file

            recursor:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - path
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, compose-scripts]
                                        comments: add/remove build file with -f
                    path:
                        type: string
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, env]
                                        comments: update build path in .env file

            vault:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - path
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, compose-scripts]
                                        comments: add/remove build file with -f
                    path:
                        type: string
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, env]
                                        comments: update build path in .env file

    reverseProxy:
        type: object
        additionalProperties: false
        required:
            - routing
            - tls
            - createTraefik
            - external
            - tempZone
            - traefikUi
        properties:
            routing:
                enum: [local, domain, minikube]
                examples:
                    - meta:
                          updatable: true
                          use:
                              - place: [compose, secrets, traefik, dynamic-config]
                                comments: update routing
            tempZone:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - provider
                    - routing
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update routing
                    provider:
                        type: string
                        description: Get a temporary subdomain for an easy and secure access while your domain changes still propagate. This subdomain will exist for 7 days, will then be deleted and not be recoverable afterwards. For pektin.zone. this implies your acceptance of our privacy policy.
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update routing
                    routing:
                        enum: [local, public]
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [requestPektinDomain]
                                        comments: function

            tls:
                type: boolean
                examples:
                    - meta:
                          updatable: true
                          use:
                              - place: [compose, secrets, traefik, dynamic-config]
                                comments: update routing
            createTraefik:
                type: boolean
                examples:
                    - meta:
                          updatable: true
                          use:
                              - place: [compose, compose-scripts]
                                comments: add/remove traefik file with -f
            traefikUi:
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - domain
                    - subDomain
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update routing
                    domain:
                        type: string
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update routing
                    subDomain:
                        type: string
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update routing
            external:
                description: Proxy to external APIs that aren't configured to use CORS.
                type: object
                additionalProperties: false
                required:
                    - enabled
                    - subDomain
                    - domain
                    - services
                properties:
                    enabled:
                        type: boolean
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update routing
                    domain:
                        $ref: "#/$defs/DomainName"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update routing
                    subDomain:
                        $ref: "#/$defs/SubDomain"
                        examples:
                            - meta:
                                  updatable: true
                                  use:
                                      - place: [compose, secrets, traefik, dynamic-config]
                                        comments: update routing
                    services:
                        type: array
                        items:
                            type: object
                            additionalProperties: false
                            required:
                                - name
                                - enabled
                                - domain
                                - accessControlAllowMethods
                            properties:
                                enabled:
                                    type: boolean
                                    examples:
                                        - meta:
                                              updatable: true
                                              use:
                                                  - place: [compose, secrets, traefik, dynamic-config]
                                                    comments: update routing
                                name:
                                    type: string
                                    examples:
                                        - meta:
                                              updatable: true
                                              use:
                                                  - place: [compose, secrets, traefik, dynamic-config]
                                                    comments: update routing
                                domain:
                                    type: string
                                    examples:
                                        - meta:
                                              updatable: true
                                              use:
                                                  - place: [compose, secrets, traefik, dynamic-config]
                                                    comments: update routing
                                accessControlAllowMethods:
                                    type: array
                                    items:
                                        type: string
                                        examples:
                                            - meta:
                                                  updatable: true
                                                  use:
                                                      - place: [compose, secrets, traefik, dynamic-config]
                                                        comments: update routing

    ansible:
        type: object
        additionalProperties: false
        required:
            - sshPubKeyName
        properties:
            sshPubKeyName:
                type: string
                examples:
                    - meta:
                          updatable: false
required:
    - services
    - nodes
    - nameservers
    - letsencrypt
    - reverseProxy
    - build
    - usePolicies

$defs:
    DomainName:
        type: string
        description: "A valid UTF8 domain name"
        #pattern: '^(?:[a-z0-9_](?:[a-z0-9-_]{0,61}[a-z0-9_]|[-]{2,}?)?\.)*[a-z0-9-_][a-z0-9-]{0,61}[a-z0-9]{1,61}[.]?$'
    SubDomain:
        type: string
        description: "A valid UTF8 domain name not ending with a dot"
        #pattern: '^(?:[a-z0-9_](?:[a-z0-9-_]{0,61}[a-z0-9_]|[-]{2,}?)?\.)*[a-z0-9-_][a-z0-9-]{0,61}[a-z0-9]{1,61}(?<!\.)$'
    Ip:
        type: string
        description: "A valid ip(ipv6) address"
        pattern: '^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$'
    LegacyIp:
        type: string
        description: "A valid legacyIp(ipv4) address"
        pattern: '^(\b25[0-5]|\b2[0-4][0-9]|\b[01]?[0-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$'
    Email:
        type: string
        description: A valid email address
        #pattern: ^(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])[.]?$
    NodeName:
        type: string
        description: A alphanumeric hostname for the node not containing double minuses "--"
        pattern: ^((?!--)[a-z0-9-_])*$
    SupportedRegistrars:
        enum: [gandi]
    AnsibleConfigType:
        type: string
        enum: [hetzner]
    AnsibleConfig:
        oneOf:
            - { $ref: "#/$defs/Hetzner" }
    Hetzner:
        type: object
        additionalProperties: false
        required:
            - configType
        properties:
            configType:
                $ref: "#/$defs/AnsibleConfigType"
            floatingIp:
                type: boolean
            floatingLegacyIp:
                type: boolean
            location:
                type: string
                enum: [nbg1, fsn1]
            serverType:
                $ref: "#/$defs/HetznerServerType"

    HetznerServerType:
        type: string
        enum: [cx11, cpx11, cx21, cpx21, cx31, cpx31, cx41, cpx41, cx51, cpx51]
